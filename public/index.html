<body data-socket-url="https://ba-exercise.onrender.com">
<div class="stage" id="stage"></div>
<div class="toolbar">
  <label class="btn">Add images<input id="addImageInput" type="file" accept="image/*" multiple></label>
  <label class="btn">Background<input id="bgInput" type="file" accept="image/*"></label>
  <div class="btn" id="clearBtn">Clear</div>
</div>

<script src="https://ba-exercise.onrender.com/socket.io/socket.io.js"></script>
<script>
const socketUrl = document.body.dataset.socketUrl;
const socket = io(socketUrl);

const stage = document.getElementById('stage');
const addImageInput = document.getElementById('addImageInput');
const bgInput = document.getElementById('bgInput');
const clearBtn = document.getElementById('clearBtn');

let selected = null;

// ---------------- Utilities ----------------
function createImageElement(data){
  if(stage.querySelector(`[data-id='${data.id}']`)) return;

  const img = document.createElement('img');
  img.src = data.src;
  img.dataset.id = data.id;
  img.className = 'draggable';
  img.style.left = data.left + 'px';
  img.style.top = data.top + 'px';
  img.style.width = data.width + 'px';
  img.dataset.locked = data.locked;
  attachHandlers(img);
  stage.appendChild(img);
}

function attachHandlers(img){
  img.addEventListener('pointerdown', startDrag);
  img.addEventListener('click', e => { e.stopPropagation(); select(img); });
}

function select(img){
  if(selected) selected.classList.remove('selected');
  selected = img;
  if(img) img.classList.add('selected');
}

// ---------------- Drag logic ----------------
stage.addEventListener('click', ()=> select(null));

function startDrag(e){
  if(e.button !== 0) return;
  const img = e.target;
  const startX = e.clientX;
  const startY = e.clientY;
  const origLeft = parseFloat(img.style.left);
  const origTop = parseFloat(img.style.top);
  img.setPointerCapture(e.pointerId);

  function move(ev){
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    const left = origLeft + dx;
    const top = origTop + dy;
    img.style.left = left + 'px';
    img.style.top = top + 'px';

    socket.emit('move_image', { id: img.dataset.id, left, top });
  }

  function end(ev){
    img.releasePointerCapture(ev.pointerId);
    img.removeEventListener('pointermove', move);
    img.removeEventListener('pointerup', end);
  }

  img.addEventListener('pointermove', move);
  img.addEventListener('pointerup', end);
}

// ---------------- Add images ----------------
addImageInput.addEventListener('change', e =>{
  const files = [...e.target.files];
  if(files.length === 0) return;

  const cols = Math.ceil(Math.sqrt(files.length));
  const gap = 20;
  const cellW = 200;
  const cellH = 200;
  const imgs = [];

  files.forEach((file,i)=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const id = 'img_' + Math.random().toString(36).slice(2);
      const r = Math.floor(i / cols);
      const c = i % cols;
      const left = c*(cellW+gap)+20;
      const top = r*(cellH+gap)+20;

      const data = { id, src: reader.result, left, top, width:200, locked:false };
      imgs.push(data);

      createImageElement(data);

      if(imgs.length === files.length){
        socket.emit('add_images', imgs);
      }
    };
    reader.readAsDataURL(file);
  });
});

// ---------------- Background ----------------
bgInput.addEventListener('change', e =>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const dataUrl = reader.result;
    stage.style.backgroundImage = `url(${dataUrl})`;
    socket.emit('set_background', dataUrl);
  };
  reader.readAsDataURL(file);
});

// ---------------- Clear ----------------
clearBtn.addEventListener('click', ()=>{
  stage.querySelectorAll('.draggable').forEach(i=>i.remove());
  stage.style.backgroundImage = '';
  socket.emit('clear_all');
});

// ---------------- Socket handlers ----------------
socket.on('initial_state', layout =>{
  if(layout.background) stage.style.backgroundImage = `url(${layout.background})`;
  layout.items.forEach(data => createImageElement(data));
});

socket.on('images_added', imgs =>{
  imgs.forEach(data => createImageElement(data));
});

socket.on('image_moved', data =>{
  const img = stage.querySelector(`[data-id='${data.id}']`);
  if(img){ img.style.left = data.left+'px'; img.style.top = data.top+'px'; }
});

socket.on('background_set', dataUrl =>{
  stage.style.backgroundImage = `url(${dataUrl})`;
});

socket.on('all_cleared', ()=>{
  stage.querySelectorAll('.draggable').forEach(i=>i.remove());
  stage.style.backgroundImage = '';
});
</script>
